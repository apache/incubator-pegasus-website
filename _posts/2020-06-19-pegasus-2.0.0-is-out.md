---
title: Pegasus Server 2.0.0 来了
layout: post
author: 吴涛
---

Pegasus Server 又发布新版本了！在去年的几个版本演进中，我们把工作的重点放在了Pegasus的服务稳定性上。在今年的 2.0.0 版本中，我们更进一步，提供了如下几个能够显著减少延迟和抖动的机制。

> Github Release: <https://github.com/XiaoMi/pegasus/releases/tag/v2.0.0>

## 跨机房异步复制

通过这个功能，我们可以把一个Pegasus表同时部署在主-备双集群上，这样上层可以实现双读，取最快者。理论上双集群同时抖动甚至故障的概率要比单集群低很多，日常情况下P99延迟相比单集群也会有显著改善。

这个方案唯一的代价是成本。因为一个数据写两份到双集群，总写入量翻倍，我们需要更多的机器来支持双倍写入量。

## Backup Request

该功能的意义在于以牺牲读一致性为代价, 换取更稳定的延迟。在推荐，广告等场景中，一致性的牺牲往往是可容忍的。

Backup Request 的实现原理很简单，如果 Pegasus 客户端发现访问延迟超过一定阈值，则会自动访问备节点。这对改善长尾延迟（tail latency）非常有帮助。在我们的测试下，长尾延迟（P999读）往往能降低 2-5 倍。

## 扩容优化

此前Pegasus在扩容时的大量数据搬迁会造成用户读延迟增高，我们研究后发现，其原因是新节点一边搬迁数据，一边提供读服务。

通过扩容优化工具，Pegasus集群的新节点会在数据迁移完成后，才提供读服务。在测试下，使用该工具能将扩容时的P99读延迟显著降低20~30倍(600ms->20ms)。

## 冷备份限流

此前Pegasus缺少对冷备份的限流, 容易导致快照数据上传至FDS(小米内部对象存储)时的流量过高。现在我们补齐了这个缺陷。

## 结语

这次我们将版本号推进到 2.0，主要是因为该版本引入了向下不兼容的修改。因此我们也同时发布了 1.12-comp-with-2.0 版本，在出现问题而需要紧急回退的时候，可以回退至该版本。待问题修复后，可以继续升级至 2.0.0。

当然，更多改进还在路上。Pegasus 2.0.0 只是我们在上一个阶段的成果，我们将会更快地推进 Pegasus 的开发进程，以提供一个更稳定，更高效，更易用的存储系统。

**最后，感谢所有使用过，参与过Pegasus的同学的支持。**

> PS: 上述功能的详细测试细节后续会以博客形式发布
