<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pegasus | Zk Migration</title>
    <link rel="stylesheet" href="/assets/css/app.css">
    <link rel="shortcut icon" href="/assets/images/favicon.ico">
    <link href="https://cdn.bootcdn.net/ajax/libs/tailwindcss/1.8.10/utilities.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.0/js/all.min.js"></script>
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Zk Migration | Pegasus</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Zk Migration" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="由于Pegasus的meta server依赖Zookeeper存储元数据和抢主，所以Zookeeper服务的不稳定会造成Pegasus服务不稳定，有时就需要迁移到其他更稳定或者空闲的Zookeeper上。" />
<meta property="og:description" content="由于Pegasus的meta server依赖Zookeeper存储元数据和抢主，所以Zookeeper服务的不稳定会造成Pegasus服务不稳定，有时就需要迁移到其他更稳定或者空闲的Zookeeper上。" />
<meta property="og:site_name" content="Pegasus" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-11-09T09:49:17+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Zk Migration" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Zk Migration","dateModified":"2020-11-09T09:49:17+00:00","datePublished":"2020-11-09T09:49:17+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"/administration/zk-migration"},"description":"由于Pegasus的meta server依赖Zookeeper存储元数据和抢主，所以Zookeeper服务的不稳定会造成Pegasus服务不稳定，有时就需要迁移到其他更稳定或者空闲的Zookeeper上。","url":"/administration/zk-migration","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
</head>


<body>
    <div class="dashboard is-full-height">
        <!-- left panel -->
        <div class="dashboard-panel is-medium is-hidden-mobile pl-0">
            <div class="dashboard-panel-header has-text-centered">
                <a href="/">
                    <img src="/assets/images/pegasus-logo-inv.png" style="width: 80%;">
                </a>
                
            </div>
            <div class="dashboard-panel-main is-scrollable pl-6">
                

<aside class="menu">
    
    <p class="menu-label">Pegasus产品文档</p>
    <ul class="menu-list">
        
        <li>
            <a href="/docs/downloads"
                class="">
                下载
            </a>
        </li>
        
    </ul>
    
    <p class="menu-label">编译构建</p>
    <ul class="menu-list">
        
        <li>
            <a href="/docs/build/compile-by-docker"
                class="">
                使用Docker完成编译
            </a>
        </li>
        
        <li>
            <a href="/docs/build/compile-from-source"
                class="">
                从源码编译
            </a>
        </li>
        
    </ul>
    
    <p class="menu-label">客户端库</p>
    <ul class="menu-list">
        
        <li>
            <a href="/clients/java-client"
                class="">
                Java客户端
            </a>
        </li>
        
        <li>
            <a href="/clients/cpp-client"
                class="">
                C++客户端
            </a>
        </li>
        
        <li>
            <a href="https://github.com/XiaoMi/pegasus-go-client"
                class="">
                Golang客户端
            </a>
        </li>
        
        <li>
            <a href="/clients/python-client"
                class="">
                Python客户端
            </a>
        </li>
        
        <li>
            <a href="/clients/node-client"
                class="">
                NodeJS客户端
            </a>
        </li>
        
        <li>
            <a href="/clients/scala-client"
                class="">
                Scala客户端
            </a>
        </li>
        
    </ul>
    
    <p class="menu-label">用户接口</p>
    <ul class="menu-list">
        
        <li>
            <a href="/api/ttl"
                class="">
                TTL
            </a>
        </li>
        
        <li>
            <a href="/api/single-atomic"
                class="">
                单行原子操作
            </a>
        </li>
        
        <li>
            <a href="/api/redis"
                class="">
                Redis适配
            </a>
        </li>
        
        <li>
            <a href="/api/geo"
                class="">
                GEO支持
            </a>
        </li>
        
        <li>
            <a href="/api/http"
                class="">
                HTTP接口
            </a>
        </li>
        
    </ul>
    
    <p class="menu-label">高效运维</p>
    <ul class="menu-list">
        
        <li>
            <a href="/administration/deployment"
                class="">
                集群部署
            </a>
        </li>
        
        <li>
            <a href="/administration/config"
                class="">
                配置说明
            </a>
        </li>
        
        <li>
            <a href="/administration/rebalance"
                class="">
                负载均衡
            </a>
        </li>
        
        <li>
            <a href="/administration/monitoring"
                class="">
                可视化监控
            </a>
        </li>
        
        <li>
            <a href="/administration/rolling-update"
                class="">
                集群升级
            </a>
        </li>
        
        <li>
            <a href="/administration/scale-in-out"
                class="">
                集群扩容缩容
            </a>
        </li>
        
        <li>
            <a href="/administration/resource-management"
                class="">
                资源管理
            </a>
        </li>
        
        <li>
            <a href="/administration/cold-backup"
                class="">
                冷备份
            </a>
        </li>
        
        <li>
            <a href="/administration/meta-recovery"
                class="">
                元数据恢复
            </a>
        </li>
        
        <li>
            <a href="/administration/replica-recovery"
                class="">
                Replica数据恢复
            </a>
        </li>
        
        <li>
            <a href="/administration/zk-migration"
                class="is-active">
                Zookeeper迁移
            </a>
        </li>
        
        <li>
            <a href="/administration/table-migration"
                class="">
                Table迁移
            </a>
        </li>
        
        <li>
            <a href="/administration/table-soft-delete"
                class="">
                Table软删除
            </a>
        </li>
        
        <li>
            <a href="/administration/table-env"
                class="">
                Table环境变量
            </a>
        </li>
        
        <li>
            <a href="/administration/remote-commands"
                class="">
                远程命令
            </a>
        </li>
        
        <li>
            <a href="/administration/partition-split"
                class="">
                Partition-Split
            </a>
        </li>
        
        <li>
            <a href="/administration/duplication"
                class="">
                跨机房同步
            </a>
        </li>
        
        <li>
            <a href="/administration/compression"
                class="">
                数据压缩
            </a>
        </li>
        
        <li>
            <a href="/administration/throttling"
                class="">
                流量控制
            </a>
        </li>
        
        <li>
            <a href="/administration/experiences"
                class="">
                运维经验
            </a>
        </li>
        
        <li>
            <a href="/administration/manual-compact"
                class="">
                Manual Compact功能
            </a>
        </li>
        
        <li>
            <a href="/administration/usage-scenario"
                class="">
                Usage Scenario功能
            </a>
        </li>
        
        <li>
            <a href="/administration/bad-disk"
                class="">
                坏盘检修
            </a>
        </li>
        
        <li>
            <a href="/administration/whitelist"
                class="">
                白名单
            </a>
        </li>
        
        <li>
            <a href="/administration/backup-request"
                class="">
                Backup Request
            </a>
        </li>
        
    </ul>
    
</aside>
            </div>
        </div>

        <!-- main section -->
        <div class="dashboard-main is-scrollable">
            <nav class="navbar is-hidden-desktop">
    <div class="navbar-brand">
        <a href="/" class="navbar-item">
            <!-- Pegasus Icon -->
            <img src="/assets/images/pegasus-square.png">
        </a>
        <div class="navbar-item">
            

<!--A simple language switch button that only supports zh and en.-->
<!--IF its language is zh, then switches to en.-->

<a class="button is-light is-outlined is-inverted" href="/en/administration/zk-migration"><strong>En</strong></a>

        </div>
        <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
            <!-- Appears in mobile mode only -->
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
    </div>
    <div class="navbar-menu" id="navMenu">
        <div class="navbar-end">
            
            <!--dropdown-->
            <div class="navbar-item has-dropdown is-hoverable">
                <a href=""
                    class="navbar-link ">
                    <span>
                        Pegasus产品文档
                    </span>
                </a>
                <div class="navbar-dropdown">
                    
                    <a href="/docs/downloads"
                        class="navbar-item ">
                        下载
                    </a>
                    
                </div>
            </div>
            
            <!--dropdown-->
            <div class="navbar-item has-dropdown is-hoverable">
                <a href=""
                    class="navbar-link ">
                    <span>
                        编译构建
                    </span>
                </a>
                <div class="navbar-dropdown">
                    
                    <a href="/docs/build/compile-by-docker"
                        class="navbar-item ">
                        使用Docker完成编译
                    </a>
                    
                    <a href="/docs/build/compile-from-source"
                        class="navbar-item ">
                        从源码编译
                    </a>
                    
                </div>
            </div>
            
            <!--dropdown-->
            <div class="navbar-item has-dropdown is-hoverable">
                <a href=""
                    class="navbar-link ">
                    <span>
                        客户端库
                    </span>
                </a>
                <div class="navbar-dropdown">
                    
                    <a href="/clients/java-client"
                        class="navbar-item ">
                        Java客户端
                    </a>
                    
                    <a href="/clients/cpp-client"
                        class="navbar-item ">
                        C++客户端
                    </a>
                    
                    <a href="https://github.com/XiaoMi/pegasus-go-client"
                        class="navbar-item ">
                        Golang客户端
                    </a>
                    
                    <a href="/clients/python-client"
                        class="navbar-item ">
                        Python客户端
                    </a>
                    
                    <a href="/clients/node-client"
                        class="navbar-item ">
                        NodeJS客户端
                    </a>
                    
                    <a href="/clients/scala-client"
                        class="navbar-item ">
                        Scala客户端
                    </a>
                    
                </div>
            </div>
            
            <!--dropdown-->
            <div class="navbar-item has-dropdown is-hoverable">
                <a href=""
                    class="navbar-link ">
                    <span>
                        用户接口
                    </span>
                </a>
                <div class="navbar-dropdown">
                    
                    <a href="/api/ttl"
                        class="navbar-item ">
                        TTL
                    </a>
                    
                    <a href="/api/single-atomic"
                        class="navbar-item ">
                        单行原子操作
                    </a>
                    
                    <a href="/api/redis"
                        class="navbar-item ">
                        Redis适配
                    </a>
                    
                    <a href="/api/geo"
                        class="navbar-item ">
                        GEO支持
                    </a>
                    
                    <a href="/api/http"
                        class="navbar-item ">
                        HTTP接口
                    </a>
                    
                </div>
            </div>
            
            <!--dropdown-->
            <div class="navbar-item has-dropdown is-hoverable">
                <a href=""
                    class="navbar-link ">
                    <span>
                        高效运维
                    </span>
                </a>
                <div class="navbar-dropdown">
                    
                    <a href="/administration/deployment"
                        class="navbar-item ">
                        集群部署
                    </a>
                    
                    <a href="/administration/config"
                        class="navbar-item ">
                        配置说明
                    </a>
                    
                    <a href="/administration/rebalance"
                        class="navbar-item ">
                        负载均衡
                    </a>
                    
                    <a href="/administration/monitoring"
                        class="navbar-item ">
                        可视化监控
                    </a>
                    
                    <a href="/administration/rolling-update"
                        class="navbar-item ">
                        集群升级
                    </a>
                    
                    <a href="/administration/scale-in-out"
                        class="navbar-item ">
                        集群扩容缩容
                    </a>
                    
                    <a href="/administration/resource-management"
                        class="navbar-item ">
                        资源管理
                    </a>
                    
                    <a href="/administration/cold-backup"
                        class="navbar-item ">
                        冷备份
                    </a>
                    
                    <a href="/administration/meta-recovery"
                        class="navbar-item ">
                        元数据恢复
                    </a>
                    
                    <a href="/administration/replica-recovery"
                        class="navbar-item ">
                        Replica数据恢复
                    </a>
                    
                    <a href="/administration/zk-migration"
                        class="navbar-item is-active">
                        Zookeeper迁移
                    </a>
                    
                    <a href="/administration/table-migration"
                        class="navbar-item ">
                        Table迁移
                    </a>
                    
                    <a href="/administration/table-soft-delete"
                        class="navbar-item ">
                        Table软删除
                    </a>
                    
                    <a href="/administration/table-env"
                        class="navbar-item ">
                        Table环境变量
                    </a>
                    
                    <a href="/administration/remote-commands"
                        class="navbar-item ">
                        远程命令
                    </a>
                    
                    <a href="/administration/partition-split"
                        class="navbar-item ">
                        Partition-Split
                    </a>
                    
                    <a href="/administration/duplication"
                        class="navbar-item ">
                        跨机房同步
                    </a>
                    
                    <a href="/administration/compression"
                        class="navbar-item ">
                        数据压缩
                    </a>
                    
                    <a href="/administration/throttling"
                        class="navbar-item ">
                        流量控制
                    </a>
                    
                    <a href="/administration/experiences"
                        class="navbar-item ">
                        运维经验
                    </a>
                    
                    <a href="/administration/manual-compact"
                        class="navbar-item ">
                        Manual Compact功能
                    </a>
                    
                    <a href="/administration/usage-scenario"
                        class="navbar-item ">
                        Usage Scenario功能
                    </a>
                    
                    <a href="/administration/bad-disk"
                        class="navbar-item ">
                        坏盘检修
                    </a>
                    
                    <a href="/administration/whitelist"
                        class="navbar-item ">
                        白名单
                    </a>
                    
                    <a href="/administration/backup-request"
                        class="navbar-item ">
                        Backup Request
                    </a>
                    
                </div>
            </div>
            
        </div>
    </div>
</nav>

<nav class="navbar is-hidden-mobile">
    <div class="navbar-start w-full">
        <div class="navbar-item pl-0 w-full">
            <!--TODO(wutao): Given the limitation of docsearch that couldn't handle multiple input,
                I make searchbox only shown in desktop. Fix this issue when docsearch.js v3 released.
                Related issue: https://github.com/algolia/docsearch/issues/230-->
            <div class="navbar-searchbox w-full bg-gray-200">
    <div class="field">
        <div class="control has-icons-right">
            <input class="input searchbox-input focus:placeholder-transparent"
                type="text" placeholder="Search the docs">
            <span class="icon is-right">
                <i class="fas fa-search searchbox-icon"></i>
            </span>
        </div>
    </div>
</div>
        </div>
    </div>
    <div class="navbar-end">
        <div class="navbar-item">
            

<!--A simple language switch button that only supports zh and en.-->
<!--IF its language is zh, then switches to en.-->

<a class="button is-light is-outlined is-inverted" href="/en/administration/zk-migration"><strong>En</strong></a>

        </div>
    </div>
</nav>

            <section class="hero is-info lg:mr-3">
                <div class="hero-body">
                    
                    <p class="title is-size-2 is-centered">Zookeeper迁移</p>
                </div>
            </section>
            <section class="section" style="padding-top: 2rem;">
                <div class="content">
                    <p>由于Pegasus的meta server依赖Zookeeper存储元数据和抢主，所以Zookeeper服务的不稳定会造成Pegasus服务不稳定，有时就需要迁移到其他更稳定或者空闲的Zookeeper上。</p>

<p>Zookeeper迁移提供了两种办法：通过元数据恢复迁移；通过zkcopy工具迁移。</p>

<h1 id="通过元数据恢复迁移">通过元数据恢复迁移</h1>

<p>Pegasus提供了<a href="meta-recovery">元数据恢复</a>功能，这个功能也可用于Zookeeper迁移。基本思路就是配置新的Zookeeper后，通过recover命令发起元数据恢复，这样元数据就写入新的Zookeeper上。</p>

<ol>
  <li>
    <p>备份app列表</p>

    <p>使用shell的<code class="language-plaintext highlighter-rouge">ls</code>命令：</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; ls -o apps.list
</code></pre></div>    </div>
  </li>
  <li>
    <p>备份node列表</p>

    <p>使用shell的<code class="language-plaintext highlighter-rouge">nodes</code>命令：</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; nodes -d -o nodes.list
</code></pre></div>    </div>

    <p>生成元数据恢复所需的<code class="language-plaintext highlighter-rouge">recover_node_list</code>文件：</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">grep </span>ALIVE nodes.list | <span class="nb">awk</span> <span class="s1">'{print $1}'</span> <span class="o">&gt;</span>recover_node_list
</code></pre></div>    </div>
  </li>
  <li>
    <p>停掉所有meta</p>

    <p>停掉所有meta server，并等待30秒以上，以保证所有replica server因为心跳超时进入INACTIVE状态。</p>
  </li>
  <li>
    <p>修改meta配置文件</p>

    <p>修改meta server的配置文件，如下：</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[meta_server]
  recover_from_replica_server = true
[zookeeper]
  hosts_list = {new zookeeper host list}
</code></pre></div>    </div>
    <ul>
      <li>将<code class="language-plaintext highlighter-rouge">recover_from_replica_server</code>设置为true</li>
      <li>将zookeeper的<code class="language-plaintext highlighter-rouge">hosts_lists</code>改为新的服务地址</li>
    </ul>
  </li>
  <li>
    <p>启动一个meta</p>

    <p>启动其中一个meta server。</p>
  </li>
  <li>
    <p>通过shell发送recover命令</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; recover -f recover_node_list
</code></pre></div>    </div>
    <p>检查恢复结果，如果出错请参考<a href="meta-recovery#常见问题整理">常见问题整理</a>排查问题。</p>
  </li>
  <li>
    <p>修改配置文件并重启meta</p>

    <p>恢复成功后，需要修改配置文件，重新改回非recovery模式：</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[meta_server]
  recover_from_replica_server = false
</code></pre></div>    </div>

    <p>重新启动所有的meta server，集群进入正常状态。</p>
  </li>
</ol>

<p>注：<a href="https://github.com/XiaoMi/pegasus/blob/master/scripts/pegasus_migrate_zookeeper.sh">scripts/pegasus_migrate_zookeeper.sh</a>是我们在内部使用的迁移Zookeeper的脚本，虽然因为服务启停功能的兼容性不能直接使用，但是可以参考其中的流程，或者进行改造。</p>

<h1 id="通过zkcopy工具迁移">通过zkcopy工具迁移</h1>

<p>基本思路就是使用zkcopy工具将原始Zookeeper数据拷贝到目标Zookeeper上，修改meta server配置文件并重启。</p>

<ol>
  <li>
    <p>停掉所有的备meta server</p>

    <p>为了防止重启主meta server时有其他的备meta server抢到锁，造成状态混乱，在整个迁移过程中只保留一个主meta server，其他的备meta server全部停掉。</p>
  </li>
  <li>
    <p>修改主meta server状态为blind</p>

    <p>将主meta server的level设置为blind（关于meta server的level介绍请参见<a href="rebalance#控制集群的负载均衡">负载均衡</a>），以禁止任何对Zookeeper数据的更新操作，防止在copy过程中出现不一致：</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; set_meta_level blind
</code></pre></div>    </div>
  </li>
  <li>
    <p>使用zkcopy工具拷贝Zookeeper数据</p>

    <p>通过shell的<code class="language-plaintext highlighter-rouge">cluster_info</code>命令获取Zookeeper元数据节点路径<code class="language-plaintext highlighter-rouge">zookeeper_root</code>，然后使用zkcopy工具将该节点的数据完全拷贝到新集群的节点上，注意需要递归拷贝。</p>
  </li>
  <li>
    <p>修改配置文件</p>

    <p>修改meta server的配置文件，将zookeeper的<code class="language-plaintext highlighter-rouge">hosts_lists</code>改为新的服务地址：</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[meta_server]
  hosts_list = {new zookeeper host list}
</code></pre></div>    </div>
  </li>
  <li>
    <p>重启主meta server</p>

    <p>重新启动主meta server，通过shell工具检查集群进入正常状态。</p>
  </li>
  <li>
    <p>启动所有备meta server</p>

    <p>启动所有备meta server，集群进入正常状态。</p>
  </li>
  <li>
    <p>清理旧Zookeeper上的数据</p>

    <p>使用zookeepercli工具的rmr命令清理旧zookeeper上的数据。</p>
  </li>
</ol>

<p>注：上面使用到的<code class="language-plaintext highlighter-rouge">zkcopy</code>和<code class="language-plaintext highlighter-rouge">zookeepercli</code>工具以后会提供出来。</p>

                </div>
            </section>
            <footer class="footer">
    <div class="container">
        <div class="content is-small has-text-centered">
            <div style="margin-bottom: 20px;">
                <a href="http://incubator.apache.org"><img src="/assets/images/egg-logo.png"
                                                           alt="Apache Incubator"/></a>
            </div>
            Copyright &copy; 2020 <a href="http://www.apache.org">The Apache Software Foundation</a>.
            Licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version
            2.0</a>.
            <br><br>
            
            Apache Pegasus is an effort undergoing incubation at The Apache Software Foundation (ASF),
            sponsored by the Apache Incubator. Incubation is required of all newly accepted projects
            until a further review indicates that the infrastructure, communications, and decision making process
            have stabilized in a manner consistent with other successful ASF projects. While incubation status is
            not necessarily a reflection of the completeness or stability of the code, it does indicate that the
            project has yet to be fully endorsed by the ASF.
            
        </div>
    </div>
</footer>
        </div>

        <!-- right panel -->
        <div class="dashboard-panel is-small is-scrollable is-hidden-mobile">
            <p class="menu-label">
    <span class="icon">
        <i class="fa fa-bars" aria-hidden="true"></i>
    </span>
    本页导航
</p>
<ul class="menu-list">
  <li><a href="#通过元数据恢复迁移">通过元数据恢复迁移</a></li>
  <li><a href="#通过zkcopy工具迁移">通过zkcopy工具迁移</a></li>
</ul>

        </div>
    </div>

    <script src="/assets/js/app.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>

<script>
    docsearch({
        indexName: 'apache_pegasus',
        apiKey: '676624c2d6dc00808d3b7cf6724fc3c8',
        inputSelector: '.searchbox-input',
        debug: true,
    });
</script>
</body>

</html>