<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pegasus | Data Model</title>
    <link rel="stylesheet" href="/zh/assets/css/app.css">
    <link rel="shortcut icon" href="/zh/assets/images/favicon.ico">
    <link rel="stylesheet" href="/zh/assets/css/utilities.min.css">
    <link rel="stylesheet" href="/zh/assets/css/docsearch.min.css" />
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/all.min.js"></script>
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Data Model | Pegasus</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Data Model" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="模型介绍" />
<meta property="og:description" content="模型介绍" />
<meta property="og:site_name" content="Pegasus" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-11-02T07:47:07+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Data Model" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-11-02T07:47:07+00:00","datePublished":"2023-11-02T07:47:07+00:00","description":"模型介绍","headline":"Data Model","mainEntityOfPage":{"@type":"WebPage","@id":"/overview/data-model/"},"url":"/overview/data-model/"}</script>
<!-- End Jekyll SEO tag -->
</head>

  <body>
    



<nav class="navbar is-primary">
    <div class="container">
        <!--container will be unwrapped when it's in docs-->
        <div class="navbar-brand">
            <a href="/zh/" class="navbar-item ">
                <!-- Pegasus Icon -->
                <img src="/assets/images/pegasus.svg">
            </a>
            <div class="navbar-item">
                <a href="/zh/docs" class="button is-primary is-outlined is-inverted">
                    <span class="icon"><i class="fas fa-book"></i></span>
                    <span>Docs</span>
                </a>
            </div>
            <div class="navbar-item is-hidden-desktop">
                  

<!--A simple language switch button that only supports zh and en.-->
<!--IF its language is zh, then switches to en.-->

<!--If you don't want a url to be relativized, you can add a space explicitly into the href to 
    prevents a url from being relativized by polyglot.-->
<a class="button is-primary is-outlined is-inverted" href=" /overview/data-model/"><strong>En</strong></a>

            </div>
            <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
                <!-- Appears in mobile mode only -->
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>
        <div class="navbar-menu" id="navMenu">
            <div class="navbar-end">
                
                 <!--dropdown-->
                <div class="navbar-item has-dropdown is-hoverable ">
                    <a href=""
                        class="navbar-link ">
                        
                        <span class="icon" style="margin-right: .25em">
                            <i class="fas fa-users"></i>
                        </span>
                        
                        <span>
                            ASF
                        </span>
                    </a>
                    <div class="navbar-dropdown">
                        
                        <a href="https://www.apache.org/"
                            class="navbar-item ">
                            Foundation
                        </a>
                        
                        <a href="https://www.apache.org/licenses/"
                            class="navbar-item ">
                            License
                        </a>
                        
                        <a href="https://www.apache.org/events/current-event.html"
                            class="navbar-item ">
                            Events
                        </a>
                        
                        <a href="https://www.apache.org/foundation/sponsorship.html"
                            class="navbar-item ">
                            Sponsorship
                        </a>
                        
                        <a href="https://www.apache.org/security/"
                            class="navbar-item ">
                            Security
                        </a>
                        
                        <a href="https://privacy.apache.org/policies/privacy-policy-public.html"
                            class="navbar-item ">
                            Privacy
                        </a>
                        
                        <a href="https://www.apache.org/foundation/thanks.html"
                            class="navbar-item ">
                            Thanks
                        </a>
                        
                    </div>
                </div>
                
                
                 <!--dropdown-->
                <div class="navbar-item has-dropdown is-hoverable ">
                    <a href="/zh/community"
                        class="navbar-link ">
                        
                        <span class="icon" style="margin-right: .25em">
                            <i class="fas fa-user-plus"></i>
                        </span>
                        
                        <span>
                            开源社区
                        </span>
                    </a>
                    <div class="navbar-dropdown">
                        
                        <a href="/zh/community/#contact-us"
                            class="navbar-item ">
                            联系我们
                        </a>
                        
                        <a href="/zh/community/#contribution"
                            class="navbar-item ">
                            参与贡献
                        </a>
                        
                        <a href="https://cwiki.apache.org/confluence/display/PEGASUS/Coding+guides"
                            class="navbar-item ">
                            编码指引
                        </a>
                        
                        <a href="https://github.com/apache/incubator-pegasus/issues?q=is%3Aissue+is%3Aopen+label%3Atype%2Fbug"
                            class="navbar-item ">
                            Bug追踪
                        </a>
                        
                        <a href="https://cwiki.apache.org/confluence/display/INCUBATOR/PegasusProposal"
                            class="navbar-item ">
                            Apache提案
                        </a>
                        
                    </div>
                </div>
                
                
                
                <a href="/zh/blogs"
                    class="navbar-item ">
                    
                    <span class="icon" style="margin-right: .25em">
                        <i class="fas fa-rss"></i>
                    </span>
                    
                    <span>Blog</span>
                </a>
                
                
                
                <a href="/zh/docs/downloads"
                    class="navbar-item ">
                    
                    <span class="icon" style="margin-right: .25em">
                        <i class="fas fa-fire"></i>
                    </span>
                    
                    <span>版本发布</span>
                </a>
                
                
            </div>
            <div class="navbar-item is-hidden-mobile">
                

<!--A simple language switch button that only supports zh and en.-->
<!--IF its language is zh, then switches to en.-->

<!--If you don't want a url to be relativized, you can add a space explicitly into the href to 
    prevents a url from being relativized by polyglot.-->
<a class="button is-primary is-outlined is-inverted" href=" /overview/data-model/"><strong>En</strong></a>

            </div>
        </div>
    </div>
</nav>

    <section class="section">
        <div class="container">
            <div class="columns is-multiline">
                <div class="column is-one-fourth">
                    
                    

<aside class="menu">
    
    <p class="menu-label"></p>
    <ul class="menu-list">
        
        <li>
            <a href="/zh/overview"
                class="">
                概览
            </a>
        </li>
        
        <li>
            <a href="/zh/overview/background"
                class="">
                项目背景
            </a>
        </li>
        
        <li>
            <a href="/zh/overview/architecture"
                class="">
                系统架构
            </a>
        </li>
        
        <li>
            <a href="/zh/overview/data-model"
                class="">
                数据模型
            </a>
        </li>
        
        <li>
            <a href="/zh/overview/benchmark"
                class="">
                性能测试
            </a>
        </li>
        
        <li>
            <a href="/zh/docs/build/compile-by-docker"
                class="">
                安装构建
            </a>
        </li>
        
        <li>
            <a href="/zh/overview/onebox"
                class="">
                体验Onebox集群
            </a>
        </li>
        
    </ul>
    
</aside>
                    
                </div>
                <div class="column is-half">
                    
                    

<div class="content">
    <h1 id="数据模型">数据模型</h1>
    <h2 id="模型介绍">模型介绍</h2>

<p>Pegasus 的数据模型非常简单，就是 Key-Value 模型，不支持数据 Schema。但是为了增强其表达能力，我们将key分裂为 <strong>HashKey</strong> 和 <strong>SortKey</strong>，即组合键（composite key），在这点上与 <a href="https://aws.amazon.com/dynamodb/">DynamoDB</a> 中提供的 <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.CoreComponents.html#HowItWorks.CoreComponents.PrimaryKey"><em>composite primary key</em></a>（partition key and sort key）是很类似的。</p>

<h3 id="hashkey">HashKey</h3>

<p>字节串，限制为64KB。类似于 DynamoDB 中的 partition key 概念，HashKey 用于计算数据属于哪个分片。Pegasus 使用一个特定的 hash 函数，对HashKey 计算出一个hash值，然后对分片个数取模，就得到该数据对应的 <strong>Partition ID</strong> 。HashKey 相同的数据总是存储在同一个分片中。</p>

<h3 id="sortkey">SortKey</h3>

<p>字节串，长度无限制。类似于 DynamoDB 中的 sort key 概念，SortKey 用于数据在分片内的排序。HashKey 相同的数据放在一起，并且按照 SortKey 的字节序排序。实际上，在内部存储到RocksDB时，我们将 HashKey 和 SortKey 拼在一起作为 RocksDB 的 key。</p>

<h3 id="value">Value</h3>

<p>字节串，长度无限制。</p>

<p><img src="/assets/images/pegasus-data-model.png" alt="pegasus-data-model" class="img-responsive docs-image" /></p>

<p>之所以这样设计，是因为：</p>

<ul>
  <li>Pegasus系统采用基于 Hash 的固定分片，必须通过一个方式计算数据的分片ID。最简单的办法就是让用户提供一个 HashKey，然后通过hash函数计算获得。</li>
  <li>如果直接采用 <code class="language-plaintext highlighter-rouge">HashKey -&gt; Value</code> 方式，在表达能力上又偏弱，不方便业务使用。所以增加了一层 SortKey，变成了 <code class="language-plaintext highlighter-rouge">[HashKey, SortKey] -&gt; Value</code> 的形式。</li>
</ul>

<h2 id="pegasus-vs-hbase">Pegasus vs. HBase</h2>

<p>虽然不及 HBase 的表格模型语义丰富，但是 Pegasus 也能满足大部分业务需求，这得益于其 HashKey+SortKey 组合键的设计。</p>

<p>譬如用户可以将 HashKey 当作 row key，将 SortKey 当作 attribute name 或者 column name，这样同一 HashKey 的多条数据可以看作一行，同样能表达出 HBase 中 row 的概念。正是考虑到这一点，Pegasus 除了提供存取单条数据的 get/set/del 接口，还提供了存取同一 HashKey 数据的 multi_get/multi_set/multi_del 接口，并且这些接口都是单行原子操作，让用户在使用时更加简单。</p>

<p><img src="/assets/images/pegasus-data-model-sample.png" alt="pegasus-data-model" class="img-responsive docs-image" /></p>

<h2 id="pegasus-vs-redis">Pegasus vs. Redis</h2>

<p>虽然不像Redis一样支持丰富的list/set/map等数据Schema，用户同样可以使用Pegasus实现类似的语义。</p>

<p>譬如用户可以将 HashKey 等同于 Redis 的 key，将 SortKey 作为 map 的 key，实现 Redis 中 map 或者 set 的语义。list 语义的支持稍微困难些，但是也可以基于 Key-Value 进行封装，譬如360开源的 <a href="https://github.com/Qihoo360/pika">Pika</a> 就做过 <a href="https://github.com/Qihoo360/pika/wiki/pika-nemo%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E6%A0%BC%E5%BC%8F#3-list%E7%BB%93%E6%9E%84%E7%9A%84%E5%AD%98%E5%82%A8">类似的事情</a>。另一种解决方案就是，将 map/set/list 数据结构通过某种方法（protobuf/thrift/json）序列化为一个字节串，然后直接作为一个整体存储在 value 中，其缺点是用户需要在客户端增加序列化/反序列化开销，并且每次数据更新都需要对整个 value 读写一次。</p>

</div>
                </div>
                <div class="column is-one-fourth is-hidden-mobile" style="padding-left: 3rem">
                    
                    <p class="menu-label">
    <span class="icon">
        <i class="fa fa-bars" aria-hidden="true"></i>
    </span>
    本页导航
</p>
<ul class="menu-list">
  <li><a href="#数据模型">数据模型</a>
    <ul>
      <li><a href="#模型介绍">模型介绍</a>
        <ul>
          <li><a href="#hashkey">HashKey</a></li>
          <li><a href="#sortkey">SortKey</a></li>
          <li><a href="#value">Value</a></li>
        </ul>
      </li>
      <li><a href="#pegasus-vs-hbase">Pegasus vs. HBase</a></li>
      <li><a href="#pegasus-vs-redis">Pegasus vs. Redis</a></li>
    </ul>
  </li>
</ul>

                    
                </div>
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="content is-small has-text-centered">
            <div style="margin-bottom: 20px;">
                <a href="http://incubator.apache.org">
                    <img src="/assets/images/egg-logo.png"
                         width="15%"
                         alt="Apache Incubator"/>
                </a>
            </div>
            Copyright &copy; 2023 <a href="http://www.apache.org">The Apache Software Foundation</a>.
            Licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version
            2.0</a>.
            <br><br>
            
            Apache Pegasus is an effort undergoing incubation at The Apache Software Foundation (ASF),
            sponsored by the Apache Incubator. Incubation is required of all newly accepted projects
            until a further review indicates that the infrastructure, communications, and decision making process
            have stabilized in a manner consistent with other successful ASF projects. While incubation status is
            not necessarily a reflection of the completeness or stability of the code, it does indicate that the
            project has yet to be fully endorsed by the ASF.
            
            <br><br>
            Apache Pegasus, Pegasus, Apache, the Apache feather logo, and the Apache Pegasus project logo are either
            registered trademarks or trademarks of The Apache Software Foundation in the United States and other
            countries.
        </div>
    </div>
</footer>
    <script src="/assets/js/app.js" type="text/javascript"></script>
  </body>
</html>
