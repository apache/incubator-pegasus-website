<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pegasus | Background</title>
    <link rel="stylesheet" href="/zh/assets/css/app.css">
    <link rel="shortcut icon" href="/zh/assets/images/favicon.ico">
    <link rel="stylesheet" href="/zh/assets/css/utilities.min.css">
    <link rel="stylesheet" href="/zh/assets/css/docsearch.v3.css">
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/all.min.js"></script>
    <script src="/assets/js/docsearch.v3.js"></script>
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Background | Pegasus</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Background" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="小米云平台长期以来一直使用开源的Apache HBase来存储结构化/半结构化数据，并逐渐成为国内使用HBase最多的公司之一，同时也培养了一个比较有实力的HBase开发团队，前后共产生了6位HBase Committer，包括一位PMC成员。可以说，HBase在小米云存储中起到了举足轻重的作用，而小米也为HBase社区贡献出一份重要的力量。" />
<meta property="og:description" content="小米云平台长期以来一直使用开源的Apache HBase来存储结构化/半结构化数据，并逐渐成为国内使用HBase最多的公司之一，同时也培养了一个比较有实力的HBase开发团队，前后共产生了6位HBase Committer，包括一位PMC成员。可以说，HBase在小米云存储中起到了举足轻重的作用，而小米也为HBase社区贡献出一份重要的力量。" />
<meta property="og:site_name" content="Pegasus" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-12-05T03:15:13+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Background" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-12-05T03:15:13+00:00","datePublished":"2023-12-05T03:15:13+00:00","description":"小米云平台长期以来一直使用开源的Apache HBase来存储结构化/半结构化数据，并逐渐成为国内使用HBase最多的公司之一，同时也培养了一个比较有实力的HBase开发团队，前后共产生了6位HBase Committer，包括一位PMC成员。可以说，HBase在小米云存储中起到了举足轻重的作用，而小米也为HBase社区贡献出一份重要的力量。","headline":"Background","mainEntityOfPage":{"@type":"WebPage","@id":"/overview/background/"},"url":"/overview/background/"}</script>
<!-- End Jekyll SEO tag -->
</head>

  <body>
    



<nav class="navbar is-primary">
    <div class="container">
        <!--container will be unwrapped when it's in docs-->
        <div class="navbar-brand">
            <a href="/zh/" class="navbar-item ">
                <!-- Pegasus Icon -->
                <img src="/assets/images/pegasus.svg">
            </a>
            <div class="navbar-item">
                <a href="/zh/docs" class="button is-primary is-outlined is-inverted">
                    <span class="icon"><i class="fas fa-book"></i></span>
                    <span>Docs</span>
                </a>
            </div>
            <div class="navbar-item is-hidden-desktop">
                  

<!--A simple language switch button that only supports zh and en.-->
<!--IF its language is zh, then switches to en.-->

<!--If you don't want a url to be relativized, you can add a space explicitly into the href to 
    prevents a url from being relativized by polyglot.-->
<a class="button is-primary is-outlined is-inverted" href=" /overview/background/"><strong>En</strong></a>

            </div>
            <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
                <!-- Appears in mobile mode only -->
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>
        <div class="navbar-menu" id="navMenu">
            <div class="navbar-end">
                
                 <!--dropdown-->
                <div class="navbar-item has-dropdown is-hoverable ">
                    <a href=""
                        class="navbar-link ">
                        
                        <span class="icon" style="margin-right: .25em">
                            <i class="fas fa-users"></i>
                        </span>
                        
                        <span>
                            ASF
                        </span>
                    </a>
                    <div class="navbar-dropdown">
                        
                        <a href="https://www.apache.org/"
                            class="navbar-item ">
                            Foundation
                        </a>
                        
                        <a href="https://www.apache.org/licenses/"
                            class="navbar-item ">
                            License
                        </a>
                        
                        <a href="https://www.apache.org/events/current-event.html"
                            class="navbar-item ">
                            Events
                        </a>
                        
                        <a href="https://www.apache.org/foundation/sponsorship.html"
                            class="navbar-item ">
                            Sponsorship
                        </a>
                        
                        <a href="https://www.apache.org/security/"
                            class="navbar-item ">
                            Security
                        </a>
                        
                        <a href="https://privacy.apache.org/policies/privacy-policy-public.html"
                            class="navbar-item ">
                            Privacy
                        </a>
                        
                        <a href="https://www.apache.org/foundation/thanks.html"
                            class="navbar-item ">
                            Thanks
                        </a>
                        
                    </div>
                </div>
                
                
                 <!--dropdown-->
                <div class="navbar-item has-dropdown is-hoverable ">
                    <a href="/zh/community"
                        class="navbar-link ">
                        
                        <span class="icon" style="margin-right: .25em">
                            <i class="fas fa-user-plus"></i>
                        </span>
                        
                        <span>
                            开源社区
                        </span>
                    </a>
                    <div class="navbar-dropdown">
                        
                        <a href="/zh/community/#contact-us"
                            class="navbar-item ">
                            联系我们
                        </a>
                        
                        <a href="/zh/community/#contribution"
                            class="navbar-item ">
                            参与贡献
                        </a>
                        
                        <a href="https://cwiki.apache.org/confluence/display/PEGASUS/Coding+guides"
                            class="navbar-item ">
                            编码指引
                        </a>
                        
                        <a href="https://github.com/apache/incubator-pegasus/issues?q=is%3Aissue+is%3Aopen+label%3Atype%2Fbug"
                            class="navbar-item ">
                            Bug追踪
                        </a>
                        
                        <a href="https://cwiki.apache.org/confluence/display/INCUBATOR/PegasusProposal"
                            class="navbar-item ">
                            Apache提案
                        </a>
                        
                    </div>
                </div>
                
                
                
                <a href="/zh/blogs"
                    class="navbar-item ">
                    
                    <span class="icon" style="margin-right: .25em">
                        <i class="fas fa-rss"></i>
                    </span>
                    
                    <span>Blog</span>
                </a>
                
                
                
                <a href="/zh/docs/downloads"
                    class="navbar-item ">
                    
                    <span class="icon" style="margin-right: .25em">
                        <i class="fas fa-fire"></i>
                    </span>
                    
                    <span>版本发布</span>
                </a>
                
                
            </div>
            <div class="navbar-item is-hidden-mobile">
                

<!--A simple language switch button that only supports zh and en.-->
<!--IF its language is zh, then switches to en.-->

<!--If you don't want a url to be relativized, you can add a space explicitly into the href to 
    prevents a url from being relativized by polyglot.-->
<a class="button is-primary is-outlined is-inverted" href=" /overview/background/"><strong>En</strong></a>

            </div>
        </div>
    </div>
</nav>

    <section class="section">
        <div class="container">
            <div class="columns is-multiline">
                <div class="column is-one-fourth">
                    
                    

<aside class="menu">
    
    <p class="menu-label"></p>
    <ul class="menu-list">
        
        <li>
            <a href="/zh/overview"
                class="">
                概览
            </a>
        </li>
        
        <li>
            <a href="/zh/overview/background"
                class="">
                项目背景
            </a>
        </li>
        
        <li>
            <a href="/zh/overview/architecture"
                class="">
                系统架构
            </a>
        </li>
        
        <li>
            <a href="/zh/overview/data-model"
                class="">
                数据模型
            </a>
        </li>
        
        <li>
            <a href="/zh/overview/benchmark"
                class="">
                性能测试
            </a>
        </li>
        
        <li>
            <a href="/zh/docs/build/compile-by-docker"
                class="">
                安装构建
            </a>
        </li>
        
        <li>
            <a href="/zh/overview/onebox"
                class="">
                体验Onebox集群
            </a>
        </li>
        
    </ul>
    
</aside>
                    
                </div>
                <div class="column is-half">
                    
                    

<div class="content">
    <h1 id="项目背景">项目背景</h1>
    <p>小米云平台长期以来一直使用开源的<a href="https://hbase.apache.org/">Apache HBase</a>来存储结构化/半结构化数据，并逐渐成为国内使用HBase最多的公司之一，同时也培养了一个比较有实力的HBase开发团队，前后共产生了6位<a href="https://hbase.apache.org/team-list.html">HBase Committer</a>，包括一位PMC成员。可以说，HBase在小米云存储中起到了举足轻重的作用，而小米也为HBase社区贡献出一份重要的力量。</p>

<p>然而，HBase并不是十全十美的，它的架构、语言、实现等决定了它具有一些难以克服的不足：</p>
<ul>
  <li>HBase实现采用的Java语言，虽然开发上效率比较高，但是运行性能并不如C/C++这样的语言。</li>
  <li>Java语言还存在GC（Garbage Collection）问题，GC时可能造成进程进入假死状态，对于Server来说就是无法提供读写服务，造成读写延迟出现突然增加，容易触发客户端超时，降低系统可用性。</li>
  <li>HBase宕机恢复时间比较长（分钟级），在这段时间内服务是不可用的。其原因是：
    <ul>
      <li>HBase使用分层架构，底层使用HDFS存储数据，上层的RegionServer仅仅是服务点（Serving Point）。为了保证数据一致性，HBase要求每个Region在同一时刻只能由一个RegionServer服务。当某个RegionServer宕机，必须选一个新的RegionServer来服务该Region。恢复过程中需要做较多处理，包括日志的传输、切分、重放，这个过程比较耗时。</li>
      <li>HBase依赖Zookeeper来探测宕机问题，而由于Java的GC问题存在，Zookeeper的session timeout不能设得太短，典型地设为30秒。如果设得太短，Java GC的假死机就容易造成session超时，触发RegionServer不必要的自杀。因此从RegionServer宕机到被发现，这中间可能就需要几十秒。</li>
    </ul>
  </li>
  <li>HBase的分层架构使数据服务点和存储位置分离，对Data Locality不够友好，也是影响其读性能的一个原因。</li>
</ul>

<p>以上这些原因造成了HBase的可用性和性能都存在一些不足，难以满足对服务可用性和延迟都很敏感的一些在线业务的需求，譬如广告业务。因此，我们急需一个不一样的系统，以弥补HBase的这些不足。在此之前，我们也调研过市面上存在的一些开源系统，包括<a href="http://cassandra.apache.org/">Apache Cassandra</a>，然而并没有一款能让我们满意。</p>

<p>基于此，从2015年开始，我们开始尝试自己开发Pegasus系统，并且从一开始就明确了我们的目标：</p>
<ul>
  <li>高可用：系统必须是高可用的，即使在部分服务器挂掉之后，也能在极短时间（秒级）内恢复服务，尽量减少对用户的影响，要求服务可用度达到99.99%以上。</li>
  <li>高性能：系统能够提供高性能的读写服务，并且在吞吐和延迟之间我们更倾向于低延迟。</li>
  <li>强一致：系统对用户提供强一致性的语义，使用户编写业务逻辑时更轻松。</li>
  <li>易伸缩：系统能够很方便增加或者减少机器节点个数，以应对业务负载的变化，并且这样的操作是自动化的，减少运维负担。</li>
  <li>易使用：系统给用户提供简单易懂的库和接口，方便用户使用。</li>
</ul>

<h1 id="设计考虑">设计考虑</h1>

<p>在设计Pegasus时，我们要在目标、实现难度、开发效率等方面做一些权衡和选择。关于这方面的考虑，我在ArchSummit 2016上做的分享中有具体介绍，参见<a href="https://www.slideshare.net/ssuser0a3cdd/pegasus-designing-a-distributed-key-value-system-arch-summit-beijing2016">slides</a>。总的来说，包括这几个方面：</p>
<ul>
  <li>开发语言：基于性能考虑，我们选择了C++。当然，我们也要忍受开发效率相对较低的问题。</li>
  <li>数据模型：采用简单的key-value数据模型。这是为了简化开发，而且我们认为key-value已经能够满足大部分业务需求。同时我们又对key-value模型做了一些改进，将key分为了HashKey和SortKey，使其表达能力更强。</li>
  <li>数据分布：采用固定Hash分布。相比Range分布和一致性Hash分布，固定Hash分布实现更简单，数据倾斜和可伸缩性可以通过合理设计Hash键和Hash函数、预设更多的桶等措施来缓解。当然我们后续还会提供partition split的功能，支持扩展分片数量。</li>
  <li>存储介质：选择SSD。SSD的性能和成本都介于内存和磁盘之间，从业务需求和成本综合考虑，选择SSD是比较合适的。</li>
  <li>单机存储引擎：选择<a href="https://github.com/facebook/rocksdb">RocksDB</a>。因为RocksDB在LevelDB基础上做了很多优化，能充分利用SSD的IOPS性能和多核服务器的计算性能。我们没有必要自己实现一个。</li>
  <li>一致性协议：选择<a href="https://www.microsoft.com/en-us/research/publication/pacifica-replication-in-log-based-distributed-storage-systems/">PacificA</a>。相比更有名的<a href="https://raft.github.io/">Raft</a>，PacificA协议具有其自身的特点和优势。两者之间具体的区别，会有专门的文档来阐述。</li>
  <li>故障检测（Failure Detection）：和HBase不同，Pegasus没有使用Zookeeper来进行故障检测，而是在MetaServer和ReplicaServer之间实现了基于租约的故障检测机制。这样一方面是避免依赖外部服务Zookeeper，同时也更方便针对自己的系统进行优化。关于故障检测，会有专门的文档进行阐述。</li>
</ul>

<h1 id="与hbase比较">与HBase比较</h1>

<p>Pegasus系统的最初目的就是弥补HBase的不足，而且上面也详细阐述了理由和设计思想。这里再从用户使用角度比较一下两者的区别：</p>
<ul>
  <li>数据模型：HBase是表格模型，采用Range分片；Pegasus是Key-Value模型，采用Hash分片。</li>
  <li>接口：HBase的API接口功能虽然很丰富，但是使用也更复杂；Pegasus的接口简单，对用户更友好。</li>
  <li>可用度：由于架构和实现的原因，HBase的可用度通常达到99.95%就不错了；Pegasus的可用度可以到达99.99%。</li>
  <li>性能：由于分层架构，HBase的读写性能不是太好，P99通常在几十甚至几百毫秒级别，而且GC问题会带来毛刺问题；Pegasus的P99可以在几毫秒，满足低延迟的在线业务需求。</li>
</ul>

<h1 id="与redis比较">与Redis比较</h1>

<p>其实Pegasus是不适合与Redis比较的，Redis是基于内存的缓存系统，与之比较性能肯定被吊打。但是我们发现，业务往往需要的不仅仅是性能，可能还有可用性、伸缩性等，所以比拼综合素质，Pegasus也是有其自身的优势的。</p>

<p>我们在与业务的沟通中发现，他们很多时候对数据的性能和可用性要求都很高。在系统选型时遇到这些问题：</p>
<ul>
  <li>HBase虽然可用性高也易伸缩，但是性能不够好。</li>
  <li>Redis虽然性能好，但是需要大量内存，如果数据量太大，一台机器搞不定；如果采用分布式方案，譬如<a href="https://redis.io/topics/cluster-tutorial">Redis Cluster</a>或者<a href="https://github.com/CodisLabs/codis">Codis</a>，在机器宕机故障情况下的可用性又不够，并且使用内存的成本也比较高。</li>
  <li>一些用户想出了HBase+Redis的方案，即使用HBase做底层存储，使用Redis做上层缓存，写数据的时候同时更新HBase和Redis，读数据的时候先从Redis中读，如果读不到再从HBase中读；但是这样的缺点是：因为涉及两个系统，用户的读写逻辑会比较复杂，且同时写两个系统时容易出现一致性问题；一份数据要存储在HBase和Redis中，成本比较高；Redis机器宕机后造成部分缓存丢失，还是要从HBase读取，性能明显降低，服务质量下降甚至降级。</li>
</ul>

<p>Pegasus可以看做是HBase和Redis的结合体，它即保证高的可用度，又具有好的伸缩性，还具有相对不错的性能。如果业务对性能的要求不是太变态（譬如P99要求在1毫秒以内），那么可以考虑直接使用Pegasus。与Redis进行比较区别如下：</p>
<ul>
  <li>数据模型：两者都是Key-Value模型，但是Pegasus支持(HashKey + SortKey)的二级键。</li>
  <li>接口：Redis的接口更丰富，支持List、Set、Map等容器特性；Pegasus的接口相对简单，功能更单一。</li>
  <li>性能：Redis性能比Pegasus好不少，Redis是在几十或者几百微妙级别，Pegasus是在毫秒级别。</li>
  <li>伸缩性：Pegasus伸缩性更好，可以很方便地增减机器节点，并支持自动的负载均衡；Redis的分布式方案在增减机器的时候比较麻烦，需要较多的运维介入。</li>
  <li>可用性：Pegasus数据总是持久化的，系统架构保证其较高的可用性；Redis在机器宕机后需要较长时间恢复，可用性不够好，还可能丢掉最后一段时间的数据。</li>
  <li>成本：Pegasus使用SSD，Redis主要使用内存，从成本上考虑，Pegasus显然更划算。</li>
</ul>

</div>
                </div>
                <div class="column is-one-fourth is-hidden-mobile" style="padding-left: 3rem">
                    
                    <p class="menu-label">
    <span class="icon">
        <i class="fa fa-bars" aria-hidden="true"></i>
    </span>
    本页导航
</p>
<ul class="menu-list">
  <li><a href="#项目背景">项目背景</a></li>
  <li><a href="#设计考虑">设计考虑</a></li>
  <li><a href="#与hbase比较">与HBase比较</a></li>
  <li><a href="#与redis比较">与Redis比较</a></li>
</ul>

                    
                </div>
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="content is-small has-text-centered">
            <div style="margin-bottom: 20px;">
                <a href="http://incubator.apache.org">
                    <img src="/assets/images/egg-logo.png"
                         width="15%"
                         alt="Apache Incubator"/>
                </a>
            </div>
            Copyright &copy; 2023 <a href="http://www.apache.org">The Apache Software Foundation</a>.
            Licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version
            2.0</a>.
            <br><br>
            
            Apache Pegasus is an effort undergoing incubation at The Apache Software Foundation (ASF),
            sponsored by the Apache Incubator. Incubation is required of all newly accepted projects
            until a further review indicates that the infrastructure, communications, and decision making process
            have stabilized in a manner consistent with other successful ASF projects. While incubation status is
            not necessarily a reflection of the completeness or stability of the code, it does indicate that the
            project has yet to be fully endorsed by the ASF.
            
            <br><br>
            Apache Pegasus, Pegasus, Apache, the Apache feather logo, and the Apache Pegasus project logo are either
            registered trademarks or trademarks of The Apache Software Foundation in the United States and other
            countries.
        </div>
    </div>
</footer>
    <script src="/assets/js/app.js" type="text/javascript"></script>
  </body>
</html>
